<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Agri Pro - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2E7D32;
            --secondary: #8BC34A;
            --bg: #F8F9FA;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --danger: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* --- LOGOUT MODAL STYLES --- */
        .logout-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 9999; transition: 0.3s opacity ease-in-out;
        }
        .logout-modal {
            background: white; padding: 30px; border-radius: 20px;
            width: 350px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.8); transition: 0.3s transform cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .logout-overlay.show { display: flex; opacity: 1; }
        .logout-overlay.show .logout-modal { transform: scale(1); }
        .logout-icon-circle {
            width: 70px; height: 70px; background: #fff5f5; color: var(--danger);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; margin: 0 auto 20px; border: 2px solid #fee2e2;
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
        .m-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-cancel { background: #f3f4f6; color: #666; }
        .btn-confirm { background: var(--danger); color: white; }
        .m-btn:hover { filter: brightness(0.9); transform: translateY(-2px); }

        /* --- SIDEBAR & MAIN PANEL --- */
        .sidebar { width: 250px; background: white; border-right: 1px solid #eee; display: flex; flex-direction: column; padding: 30px 20px; }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; color: var(--primary); font-size: 20px; font-weight: bold; margin-bottom: 50px; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 12px; cursor: pointer; color: #666; transition: 0.3s; margin-bottom: 5px; text-decoration: none; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:hover:not(.active) { background: #f0f0f0; }

        .main-panel { flex: 1; overflow-y: auto; padding: 30px; }
        .top-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 18px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 15px; }
        .stat-box i { font-size: 24px; color: var(--primary); opacity: 0.8; }
        .stat-info p { font-size: 12px; color: #888; }
        .stat-info h3 { font-size: 16px; color: #333; }

        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .map-section { background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow); }
        .map-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        
        .map-placeholder { 
            width: 100%; 
            height: 300px; 
            background: #e0e0e0; 
            border-radius: 15px; 
            background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&q=80&w=1000'); 
            background-size: cover; 
            background-position: center;
            position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
        }

        /* --- SERVICE CARDS STYLES --- */
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .service-card { background: white; border-radius: 15px; padding: 15px; box-shadow: var(--card-shadow); border: 1px solid #eee; transition: 0.3s; cursor: pointer; text-decoration: none; color: inherit; }
        .service-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .service-card i { font-size: 20px; color: var(--primary); margin-bottom: 10px; display: block; }
        .service-card h4 { font-size: 14px; margin-bottom: 5px; }
        .service-card p { font-size: 11px; color: #777; line-height: 1.4; }

        .ai-panel { background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; }
        .ai-btn { background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; text-decoration: none; margin-top: 15px; }
        
        .land-footer { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .mini-card { background: white; padding: 15px; border-radius: 15px; box-shadow: var(--card-shadow); border-left: 5px solid var(--primary); position: relative; }
        
        .service-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .s-btn { border: none; padding: 8px; border-radius: 10px; font-size: 10px; cursor: pointer; text-align: center; }
        .s-btn i { display: block; font-size: 14px; margin-bottom: 4px; }

        .btn-drone { background: #E8F5E9; color: var(--primary); }
        .btn-harvest { background: #FFF3E0; color: #E65100; }
        .btn-pump { background: #E3F2FD; color: #1565C0; }

        .del-btn { position: absolute; top: 10px; right: 10px; color: #ddd; cursor: pointer; border: none; background: none; }
        .del-btn:hover { color: #f44336; }

        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 15px; }
            .sidebar-logo, .nav-item span { display: none; }
            .content-grid { grid-template-columns: 1fr; }
            .top-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div id="logoutOverlay" class="logout-overlay">
        <div class="logout-modal">
            <div class="logout-icon-circle"><i class="fas fa-sign-out-alt"></i></div>
            <h3 style="color:#333; margin-bottom:10px;">লগআউট করতে চান?</h3>
            <p style="color:#777; font-size:14px;">আপনি কি নিশ্চিত যে আপনার অ্যাকাউন্ট থেকে বের হয়ে যেতে চান?</p>
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeLogoutModal()">বাতিল</button>
                <button class="m-btn btn-confirm" id="confirmLogout">হ্যাঁ, বের হোন</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-logo"><i class="fas fa-leaf"></i> Agri Pro</div>
        <a href="#" class="nav-item active"><i class="fas fa-th-large"></i> <span>Dashboard</span></a>
        <a href="map.html" class="nav-item"><i class="fas fa-map"></i> <span>My Lands</span></a>
        <a href="scanner.html" class="nav-item"><i class="fas fa-robot"></i> <span>AI Scanner</span></a>
        <a href="services.html" class="nav-item"><i class="fas fa-tools"></i> <span>Services</span></a> <a href="#" class="nav-item"><i class="fas fa-user"></i> <span>Profile</span></a>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="openLogoutModal()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></div>
    </div>

    <div class="main-panel">
        <div class="top-stats">
            <div class="stat-box"><i class="fas fa-cloud-sun"></i><div class="stat-info"><p>আবহাওয়া</p><h3 id="weather">লোড হচ্ছে...</h3></div></div>
            <div class="stat-box"><i class="fas fa-plane-departure"></i><div class="stat-info"><p>ড্রোন সার্ভিস</p><h3>সক্রিয়</h3></div></div>
            <div class="stat-box"><i class="fas fa-seedling"></i><div class="stat-info"><p>মাটির স্বাস্থ্য</p><h3>৭৪%</h3></div></div>
            <div class="stat-box"><i class="fas fa-coins"></i><div class="stat-info"><p>ধানের বাজার দর</p><h3>১২৫০৳</h3></div></div>
        </div>

        <div class="content-grid">
            <div class="map-section">
                <div class="map-header">
                    <h2 id="display-name">লোড হচ্ছে...</h2>
                    <a href="map.html?mode=add" style="color:var(--primary); text-decoration:none; font-weight:bold">+ জমি যোগ করুন</a>
                </div>
                <div class="map-placeholder"></div>
            </div>

            <div class="ai-panel">
                <h3>স্মার্ট সার্ভিসসমূহ</h3>
                
                <div class="service-grid">
                    <a href="drone-control.html" class="service-card">
                        <i class="fas fa-drone"></i>
                        <h4>স্মার্ট ড্রোন</h4>
                        <p>কীটনাশক ছেটানো ও জমি পর্যবেক্ষণ।</p>
                    </a>
                    <a href="pump-automation.html" class="service-card">
                        <i class="fas fa-faucet-drip"></i>
                        <h4>অটো পাম্প</h4>
                        <p>সেন্সর ভিত্তিক স্বয়ংক্রিয় সেচ ব্যবস্থা।</p>
                    </a>
                </div>

                <div style="margin:20px 0 10px; font-size:14px; color:#666; border-top:1px solid #eee; pt:15px">
                    <p>AI বিশেষজ্ঞের সাহায্য নিন:</p>
                </div>
                <a href="scanner.html" class="ai-btn"><i class="fas fa-camera"></i> রোগ শনাক্তকরণ</a>
            </div>
        </div>

        <h3 style="margin: 30px 0 15px;">আপনার নিবন্ধিত জমিসমূহ</h3>
        <div class="land-footer" id="land-list"></div>
    </div>

    <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            let finalName = "কৃষক বন্ধু";

            if (userDoc.exists()) {
                finalName = userDoc.data().fullName || "কৃষক বন্ধু";
            } else if (user.displayName) {
                finalName = user.displayName;
            }
            
            document.getElementById('display-name').innerText = "হ্যালো, " + finalName;
            document.getElementById('weather').innerText = "২৯°C পরিষ্কার";
            
            renderLands(user.uid);
        } else { 
            window.location.href = 'index.html'; 
        }
    });

    window.openLogoutModal = () => document.getElementById('logoutOverlay').classList.add('show');
    window.closeLogoutModal = () => document.getElementById('logoutOverlay').classList.remove('show');

    document.getElementById('confirmLogout').addEventListener('click', () => {
        signOut(auth).then(() => { window.location.href = 'index.html'; });
    });

    // আপডেট করা renderLands ফাংশন
    async function renderLands(uid) {
        const container = document.getElementById('land-list');
        container.innerHTML = "লোড হচ্ছে...";
        const q = query(collection(db, "lands"), where("userId", "==", uid));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) { container.innerHTML = "কোনো জমি পাওয়া যায়নি।"; return; }

        let html = "";
        querySnapshot.forEach((docSnap) => {
            const land = docSnap.data();
            
            // নতুন লজিক: ফসলের নাম এবং ম্যাপ লিঙ্ক তৈরি করা
            const crop = land.cropName || "নির্ধারিত নেই";
            // ল্যাটিটিউড এবং লঙ্গিটিউড থাকলে গুগল ম্যাপসের লিঙ্ক তৈরি হবে
            const mapUrl = (land.lat && land.lng) 
                ? `https://www.google.com/maps?q=${land.lat},${land.lng}` 
                : "map.html";

            html += `
                <div class="mini-card" style="padding-bottom: 20px;">
                    <button class="del-btn" onclick="deleteLand('${docSnap.id}')"><i class="fas fa-times-circle"></i></button>
                    <strong style="display:block; margin-bottom:5px;">${land.name}</strong>
                    
                    <div style="font-size: 11px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">
                        <i class="fas fa-seedling"></i> ফসল: ${crop}
                    </div>

                    <small style="color:#777"><i class="fas fa-expand"></i> ${land.area} শতাংশ</small>
                    
                    <div style="margin-top: 10px;">
                        <a href="${mapUrl}" target="_blank" style="text-decoration:none; font-size:10px; background:#f0f0f0; padding:4px 8px; border-radius:5px; color:#333; display:inline-block;">
                            <i class="fas fa-location-dot"></i> ম্যাপে দেখুন
                        </a>
                    </div>

                    <div class="service-btns">
                        <button class="s-btn btn-drone" onclick="orderService('ড্রোন', '${land.name}')"><i class="fas fa-plane"></i>ড্রোন</button>
                        <button class="s-btn btn-harvest" onclick="orderService('কাটাই', '${land.name}')"><i class="fas fa-tractor"></i>কাটাই</button>
                        <button class="s-btn btn-pump" onclick="orderService('পাম্প', '${land.name}')"><i class="fas fa-water"></i>পাম্প</button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
    }

    window.orderService = (s, l) => alert("অর্ডার হয়েছে: " + s + " (" + l + ")");
    window.deleteLand = async (id) => { 
        if(confirm("মুছে ফেলবেন?")) { 
            await deleteDoc(doc(db, "lands", id)); 
            location.reload(); 
        } 
    }
</script>
</body>
</html>


