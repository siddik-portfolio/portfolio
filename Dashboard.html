<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Agri Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f4f7f6; color: #333; padding-bottom: 30px; }
        
        /* হেডার ডিজাইন আপডেট */
        .header { 
            background: linear-gradient(135deg, #2E7D32, #1B5E20); 
            color: white; padding: 35px 20px; 
            border-radius: 0 0 30px 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            position: relative;
        }
        .user-info h2 { font-size: 22px; margin-bottom: 5px; }
        .user-info p { opacity: 0.9; font-size: 14px; }

        /* নতুন ওয়েদার এবং মার্কেট কার্ড সেকশন */
        .info-scroll {
            display: flex;
            gap: 15px;
            padding: 0 20px;
            margin-top: -25px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .info-scroll::-webkit-scrollbar { display: none; }
        .info-card {
            background: white;
            min-width: 160px;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .info-card i { font-size: 24px; color: #2E7D32; margin-bottom: 8px; }
        .info-card span { font-size: 12px; color: #777; }
        .info-card b { font-size: 15px; color: #333; }

        .btn-ai { 
            background: linear-gradient(135deg, #1B5E20, #43A047); 
            color: white; padding: 18px; 
            border-radius: 15px; text-align: center; 
            text-decoration: none; display: flex; 
            align-items: center; justify-content: center; 
            gap: 10px; margin: 20px; 
            font-weight: bold; box-shadow: 0 4px 12px rgba(46,125,50,0.3); 
        }

        .section-title { padding: 10px 20px; font-size: 18px; font-weight: bold; color: #2E7D32; display: flex; justify-content: space-between; align-items: center; }
        .add-land-btn { background: #2E7D32; color: #fff; padding: 8px 15px; border-radius: 10px; text-decoration: none; font-size: 14px; font-weight: bold; }
        
        .land-container { padding: 10px 20px; }
        .land-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 6px solid #4CAF50; position: relative; }
        .land-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .land-meta { font-size: 13px; color: #777; margin-bottom: 15px; }
        
        .service-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .s-btn { border: none; padding: 10px 5px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.3s; }
        .s-btn:active { transform: scale(0.95); }
        .btn-drone { background: #E8F5E9; color: #2E7D32; }
        .btn-harvest { background: #FFF3E0; color: #E65100; }
        .btn-pump { background: #E3F2FD; color: #1565C0; }
        
        .empty-msg { text-align: center; padding: 50px 20px; color: #999; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; float: right; cursor: pointer; }
        
        /* ডিলিট বাটন ডিজাইন */
        .del-btn { position: absolute; top: 15px; right: 15px; color: #ffcdd2; border: none; background: none; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div class="header">
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        <div class="user-info">
            <h2 id="display-name">লোড হচ্ছে...</h2>
            <p id="display-phone"><i class="fas fa-phone-alt"></i> অপেক্ষা করুন...</p>
        </div>
    </div>

    <div class="info-scroll">
        <div class="info-card">
            <i class="fas fa-cloud-sun"></i>
            <span>আবহাওয়া</span>
            <b>২৯°C রৌদ্রোজ্জ্বল</b>
        </div>
        <div class="info-card">
            <i class="fas fa-chart-line"></i>
            <span>ধানের বাজার দর</span>
            <b>১২৫০৳ / মন</b>
        </div>
        <div class="info-card">
            <i class="fas fa-tint"></i>
            <span>মাটির আর্দ্রতা</span>
            <b>৪৫% (স্বাভাবিক)</b>
        </div>
    </div>

    <a href="scanner.html" class="btn-ai"><i class="fas fa-robot"></i> AI ফসলের রোগ নির্ণয় করুন</a>

    <div class="section-title">
        আপনার জমিসমূহ
        <a href="map.html?mode=add" class="add-land-btn"><i class="fas fa-plus"></i> যোগ করুন</a>
    </div>

    <div class="land-container" id="land-list">
        </div>

    

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ১. লগইন স্ট্যাটাস এবং ইউজার ডেটা চেক (অপরিবর্তিত)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById('display-name').innerText = "হ্যালো, " + (userData.fullName || "কৃষক বন্ধু") + "!";
                        document.getElementById('display-phone').innerHTML = `<i class="fas fa-phone-alt"></i> ${userData.phone || "সেট করা নেই"}`;
                    } else {
                        document.getElementById('display-name').innerText = "হ্যালো, " + (user.displayName || "কৃষক বন্ধু") + "!";
                        document.getElementById('display-phone').innerText = user.email;
                    }
                    renderLands(user.uid);
                } catch (error) {
                    console.error("Error loading user profile:", error);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // ২. Firebase থেকে জমির তালিকা রেন্ডার করা (অপরিবর্তিত)
        async function renderLands(uid) {
            const container = document.getElementById('land-list');
            container.innerHTML = `<div class="empty-msg"><p>জমি লোড হচ্ছে...</p></div>`;

            try {
                const q = query(collection(db, "lands"), where("userId", "==", uid));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    container.innerHTML = `<div class="empty-msg"><i class="fas fa-map-marked-alt fa-3x" style="color:#ddd"></i><p><br>কোনো জমি পাওয়া যায়নি। নিচের বাটনে ক্লিক করে জমি যোগ করুন।</p></div>`;
                    return;
                }

                let html = "";
                querySnapshot.forEach((docSnap) => {
                    const land = docSnap.data();
                    const landId = docSnap.id; 
                    html += `
                        <div class="land-card">
                            <button class="del-btn" onclick="deleteLand('${landId}')"><i class="fas fa-trash-alt"></i></button>
                            <div onclick="viewLandOnMap('${landId}')" style="cursor:pointer">
                                <div class="land-name">${land.name || 'নামহীন জমি'}</div>
                                <div class="land-meta">
                                    <span><i class="fas fa-expand-arrows-alt"></i> ${land.area || '0'} শতাংশ</span> | 
                                    <span><i class="fas fa-map-marker-alt"></i> ম্যাপে দেখুন</span>
                                </div>
                            </div>
                            <div class="service-group">
                                <button class="s-btn btn-drone" onclick="orderService('ড্রোন স্প্রে', '${land.name}')"><i class="fas fa-plane"></i>ড্রোন</button>
                                <button class="s-btn btn-harvest" onclick="orderService('হারভেস্ট', '${land.name}')"><i class="fas fa-tractor"></i>কাটাই</button>
                                <button class="s-btn btn-pump" onclick="orderService('স্মার্ট পাম্প', '${land.name}')"><i class="fas fa-water"></i>পাম্প</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error("Lands load korte somossya:", error);
                container.innerHTML = `<div class="empty-msg"><p>ডেটা লোড করতে সমস্যা হয়েছে।</p></div>`;
            }
        }

        // ৩. গ্লোবাল ফাংশনসমূহ (অপরিবর্তিত)
        window.logout = function() {
            if(confirm("আপনি কি লগআউট করতে চান?")) {
                signOut(auth).then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => alert(error.message));
            }
        }

        window.viewLandOnMap = function(landId) {
            window.location.href = `map.html?mode=view&landId=${landId}`;
        }

        window.orderService = function(s, l) {
            alert("✅ অর্ডার কনফার্ম!\nসার্ভিস: " + s + "\nজমি: " + l + "\nশীঘ্রই আমাদের প্রতিনিধি যোগাযোগ করবেন।");
        }

        window.deleteLand = async function(landId) {
            if(confirm("আপনি কি নিশ্চিতভাবে এই জমির তথ্য মুছে ফেলতে চান?")) {
                try {
                    await deleteDoc(doc(db, "lands", landId));
                    alert("তথ্য মুছে ফেলা হয়েছে।");
                    location.reload(); 
                } catch (error) {
                    alert("মুছে ফেলতে সমস্যা হয়েছে: " + error.message);
                }
            }
        }
    </script>
</body>
</html>
