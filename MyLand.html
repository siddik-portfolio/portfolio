<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2E7D32; --secondary: #1b5e20; --bg: #F0F2F5; --glass: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Land Grid & Card Design */
        .land-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto; }
        .land-card { background: white; border-radius: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.4s; border: 1px solid rgba(0,0,0,0.03); position: relative; }
        .land-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .card-banner { width: 100%; height: 180px; position: relative; }
        .card-banner img { width: 100%; height: 100%; object-fit: cover; }
        .crop-select-wrapper { position: absolute; top: 15px; right: 15px; z-index: 10; }
        .crop-select { appearance: none; background: var(--glass); color: var(--primary); padding: 6px 30px 6px 15px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .card-content { padding: 20px; }
        .card-content h3 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #f8faf9; padding: 12px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .info-item { text-align: center; }
        .info-item p { margin: 0; font-size: 10px; color: #888; text-transform: uppercase; }
        .info-item h4 { margin: 2px 0; font-size: 13px; color: #333; }

        /* Status Tracking Design */
        .service-status-box { margin-top: 15px; padding: 12px; border-radius: 15px; background: #f9f9f9; font-size: 12px; text-align: center; border: 1px dashed #ddd; color: #888; transition: 0.3s; }
        .status-active { background: #E8F5E9; border: 1px solid #A5D6A7; color: #2E7D32; font-weight: bold; border-style: solid; }

        .action-btn { width: 100%; background: #222; color: white; border: none; padding: 14px; border-radius: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; margin-top: 15px; }
        .action-btn:hover { background: var(--primary); }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Modal & UI Elements */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .glass-card { background: var(--glass); border-radius: 35px; padding: 30px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.4); scrollbar-width: none; }
        
        .service-option { width: 100%; padding: 20px; margin-bottom: 15px; border-radius: 22px; border: 1px solid #eee; background: white; cursor: pointer; display: flex; align-items: center; gap: 18px; transition: 0.3s; }
        .service-option:hover { transform: scale(1.02); border-color: var(--primary); }
        .service-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

        .smart-select { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 14px; outline: none; }
        .fert-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .fert-box { background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #eee; }
        .fert-box label { font-size: 10px; color: #999; display: block; margin-bottom: 4px; }
        .fert-input { width: 100%; border: none; font-size: 16px; font-weight: bold; color: var(--primary); outline: none; background: transparent; }
        .reason-box { background: #E8F5E9; border-left: 5px solid var(--primary); padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 13px; color: #2E7D32; display: none; line-height: 1.5; }
        
        .success-prism { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(25px) saturate(200%); border-radius: 30px; padding: 40px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); animation: prismScale 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes prismScale { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pump-active { animation: pulse 2s infinite; color: #2196F3 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="land-list" class="land-grid"></div>

    <div id="serviceModal" class="modal-overlay" onclick="closeModal()">
        <div class="glass-card" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="modalTitle" style="margin:0; font-size: 22px;">সার্ভিস নির্বাচন করুন</h2>
                <i class="fas fa-times" onclick="closeModal()" style="cursor:pointer; font-size: 20px; color: #ccc;"></i>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { collection, query, where, onSnapshot, updateDoc, doc, addDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const CROP_DB = {
            'ধান': { varieties: ['ব্রি-ধান ৮৯', 'ব্রি-ধান ২৯', 'বিনা-ধান ১০', 'হাইব্রিড হীরা-২', 'নাজিরশাইল', 'মিনিকেট'], ratios: { urea: 1.1, dap: 0.6, mop: 0.5, gyp: 0.3 } },
            'গম': { varieties: ['বারি গম-৩০', 'বারি গম-৩৩', 'শতাব্দী', 'কাঞ্চন'], ratios: { urea: 0.9, dap: 0.8, mop: 0.4, gyp: 0.2 } },
            'ভুট্টা': { varieties: ['বারি হাইব্রিড-১৬', 'পায়োনিয়ার ৩৩৩৫', 'ডিকাল্ব ৯১৪৪'], ratios: { urea: 1.8, dap: 1.2, mop: 0.9, gyp: 0.5 } },
            'আলু': { varieties: ['ডায়মন্ড', 'কার্ডিনাল', 'লাল পাকরি', 'বারি আলু-৭'], ratios: { urea: 1.3, dap: 1.0, mop: 1.4, gyp: 0.4 } },
            'সরিষা': { varieties: ['বারি সরিষা-১৪', 'মাঘী সরিষা', 'বিনা সরিষা-৯'], ratios: { urea: 0.8, dap: 0.9, mop: 0.4, gyp: 0.7 } },
            'পেঁয়াজ': { varieties: ['বারি পেঁয়াজ-১', 'লাল তীর কিং', 'সুখসাগর'], ratios: { urea: 1.0, dap: 1.0, mop: 0.8, gyp: 0.4 } }
        };

        const PEST_DB = {
            'ধান': { 'মাজরা পোকা': ['ভায়াগো', 'বেল্ট এক্সপার্ট'], 'ব্লাস্ট রোগ': ['নাティブো', 'এমিস্টার টপ'], 'টুংরো': ['টিডো'] },
            'আলু': { 'লেইট ব্লাইট': ['রিডোমিল গোল্ড'], 'কাটুই পোকা': ['ফুরাডান'] },
            'গম': { 'ব্লাস্ট': ['নাティブো'], 'মরিচা রোগ': ['টিল্ট'] }
        };

        const cropImages = { 'ধান': 'https://images.unsplash.com/photo-1536657464919-892534f60d6e?q=80&w=600', 'default': 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=600' };
        window.currentLand = null;
        let isProcessing = false;

        onAuthStateChanged(auth, (user) => {
            if (user) setupLands(user.uid);
            else window.parent.location.href = 'index.html';
        });

        function setupLands(uid) {
            const q = query(collection(db, "lands"), where("userId", "==", uid));
            onSnapshot(q, (snaps) => {
                const container = document.getElementById('land-list');
                container.innerHTML = "";
                snaps.forEach(d => {
                    renderCard(d.id, d.data());
                });
            });
        }

        function renderCard(id, data) {
            const container = document.getElementById('land-list');
            const crop = data.cropName || 'ধান';
            const moisture = data.moistureLevel || 40;
            
            const cardHtml = `
                <div class="land-card">
                    <div class="card-banner">
                        <img src="${cropImages[crop] || cropImages.default}">
                        <div class="crop-select-wrapper">
                            <select class="crop-select" onchange="updateDoc(doc(db, 'lands', '${id}'), {cropName: this.value})">
                                <option value="${crop}">${crop}</option>
                                ${Object.keys(CROP_DB).map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <h3>${data.name}</h3>
                        <div class="info-grid">
                            <div class="info-item"><p>আর্দ্রতা</p><h4 style="color:${moisture<35?'red':'green'}">${moisture}%</h4></div>
                            <div class="info-item"><p>পাম্প</p><h4 class="${data.pumpStatus==='ON'?'pump-active':''}">${data.pumpStatus || 'OFF'}</h4></div>
                            <div class="info-item"><p>এলাকা</p><h4>${data.area} শতক</h4></div>
                        </div>
                        <div id="status-${id}" class="service-status-box">চলমান কোনো সার্ভিস নেই</div>
                        <button class="action-btn" onclick="openServiceMenu('${id}', '${data.name}', ${data.area}, '${crop}')">
                            <i class="fas fa-th-large"></i> সার্ভিস নিন
                        </button>
                    </div>
                </div>`;
            container.innerHTML += cardHtml;

            const orderQ = query(collection(db, "orders"), where("landId", "==", id), where("status", "in", ["PENDING", "PROCESSING"]));
            onSnapshot(orderQ, (orderSnaps) => {
                const statusBox = document.getElementById(`status-${id}`);
                if(!statusBox) return;
                if(orderSnaps.empty) {
                    statusBox.innerHTML = "চলমান কোনো সার্ভিস নেই";
                    statusBox.className = "service-status-box";
                } else {
                    const order = orderSnaps.docs[0].data();
                    statusBox.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> ${order.serviceType}: ${order.status === 'PENDING' ? 'অপেক্ষা করুন...' : 'কাজ চলছে'}`;
                    statusBox.className = "service-status-box status-active";
                }
            });
        }

        // --- নতুন লজিক: অ্যাক্টিভ অর্ডার থাকলে নতুন অর্ডার নিবে না ---
        window.confirmWithPrism = async (type) => {
            if (isProcessing) return;

            const btn = event.target.closest('button') || event.target;
            const originalHTML = btn.innerHTML;
            const { id, name, area, crop } = window.currentLand;

            try {
                isProcessing = true;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> চেক করা হচ্ছে...`;

                // ১. অ্যাক্টিভ অর্ডার চেক করার কুইরি
                const activeOrderQ = query(
                    collection(db, "orders"), 
                    where("landId", "==", id), 
                    where("status", "in", ["PENDING", "PROCESSING"])
                );
                
                const querySnapshot = await getDocs(activeOrderQ);

                // ২. যদি অ্যাক্টিভ অর্ডার থাকে তবে অ্যালার্ট দিবে
                if (!querySnapshot.empty) {
                    document.getElementById('modalTitle').innerText = "অর্ডার সীমাবদ্ধ";
                    document.getElementById('modalContent').innerHTML = `
                        <div class="success-prism" style="border-color: #ff9800;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 50px; color:#ff9800; margin-bottom:15px; display:block;"></i>
                            <h3 style="margin:0; color: #e65100;">অ্যাক্টিভ সার্ভিস চলমান!</h3>
                            <p style="font-size:13px; color:#666; margin-top:10px;">
                                আপনার এই জমিতে অলরেডি একটি কাজ চলছে। সেটি শেষ না হওয়া পর্যন্ত নতুন অর্ডার নেওয়া সম্ভব নয়।
                            </p>
                            <button class="action-btn" style="margin-top:20px; background:#ff9800;" onclick="closeModal()">ঠিক আছে</button>
                        </div>`;
                    return; // ফাংশন এখানেই শেষ
                }

                // ৩. কোনো অ্যাক্টিভ অর্ডার না থাকলে নতুন অর্ডার সেভ হবে
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> প্রসেসিং...`;
                const orderData = {
                    landId: id,
                    landName: name,
                    serviceType: type,
                    status: 'PENDING',
                    timestamp: new Date().getTime(),
                    userId: auth.currentUser.uid
                };

                await addDoc(collection(db, "orders"), orderData);
                document.getElementById('modalTitle').innerText = "স্ট্যাটাস";
                document.getElementById('modalContent').innerHTML = `
                    <div class="success-prism">
                        <i class="fas fa-check-circle" style="font-size: 50px; color:#4CAF50; margin-bottom:15px; display:block;"></i>
                        <h3 style="margin:0;">অর্ডার সফল!</h3>
                        <p style="font-size:13px; color:#666;">আপনার ${type} রিকোয়েস্টটি গ্রহণ করা হয়েছে।</p>
                        <button class="action-btn" style="margin-top:20px;" onclick="closeModal()">ঠিক আছে</button>
                    </div>`;

            } catch (e) { 
                alert("Error: " + e.message); 
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            } finally {
                isProcessing = false;
            }
        };

        // বাকি ফাংশনগুলো অপরিবর্তিত রাখা হয়েছে
        window.openServiceMenu = (id, name, area, crop) => {
            window.currentLand = { id, name, area, crop };
            document.getElementById('modalTitle').innerText = "সার্ভিস নির্বাচন করুন";
            document.getElementById('modalContent').innerHTML = `
                <div class="service-option" onclick="showDroneOptions()"><div class="service-icon" style="background:#E8F5E9; color:#2E7D32;"><i class="fas fa-helicopter"></i></div><div><b>ড্রোন স্প্রে সার্ভিস</b><p style="margin:0; font-size:11px; color:#888;">সার ও কীটনাশক প্রয়োগ</p></div></div>
                <div class="service-option" onclick="openHalchashMenu()"><div class="service-icon" style="background:#FFF3E0; color:#EF6C00;"><i class="fas fa-tractor"></i></div><div><b>স্মার্ট হালচাষ</b><p style="margin:0; font-size:11px; color:#888;">আধুনিক প্রযুক্তিতে জমি তৈরি</p></div></div>
                <div class="service-option" onclick="confirmWithPrism('ফসল কাটা')"><div class="service-icon" style="background:#E3F2FD; color:#1565C0;"><i class="fas fa-wheat-awn"></i></div><div><b>আধুনিক ফসল কাটা</b><p style="margin:0; font-size:11px; color:#888;">কম্বাইন হার্ভেস্টার সার্ভিস</p></div></div>`;
            document.getElementById('serviceModal').style.display = 'flex';
        };

        window.showDroneOptions = () => {
            document.getElementById('modalContent').innerHTML = `
                <div class="service-option" onclick="openFertilizerExpert()"><div class="service-icon" style="background:#F3E5F5; color:#7B1FA2;"><i class="fas fa-flask"></i></div><div><b>সায়েন্টিফিক সার প্রয়োগ</b><p style="margin:0; font-size:11px; color:#888;">জাত ভিত্তিক হিসাব</p></div></div>
                <div class="service-option" onclick="openPesticideExpert()"><div class="service-icon" style="background:#FFEBEE; color:#C62828;"><i class="fas fa-bug"></i></div><div><b>কীটনাশক স্প্রে</b><p style="margin:0; font-size:11px; color:#888;">রোগ অনুযায়ী সমাধান</p></div></div>
                <button class="action-btn" style="background:#eee; color:#666;" onclick="openServiceMenu(window.currentLand.id, window.currentLand.name, window.currentLand.area, window.currentLand.crop)">পিছনে যান</button>`;
        };

        window.openPesticideExpert = () => {
            const crop = window.currentLand.crop;
            const diseases = PEST_DB[crop] || PEST_DB['ধান'];
            document.getElementById('modalTitle').innerText = "কীটনাশক নির্বাচন (" + crop + ")";
            document.getElementById('modalContent').innerHTML = `
                <select id="diseaseSelect" class="smart-select" onchange="loadMedicines()">
                    <option value="">রোগ নির্বাচন করুন</option>
                    ${Object.keys(diseases).map(d => `<option value="${d}">${d}</option>`).join('')}
                </select>
                <div id="medContainer"></div>
                <button class="action-btn" style="margin-top:20px;" onclick="confirmWithPrism('কীটনাশক স্প্রে')">স্প্রে অর্ডার করুন</button>`;
        };

        window.loadMedicines = () => {
            const d = document.getElementById('diseaseSelect').value;
            const meds = PEST_DB[window.currentLand.crop][d];
            document.getElementById('medContainer').innerHTML = `<select id="medSelect" class="smart-select">${meds.map(m => `<option value="${m}">${m}</option>`).join('')}</select>`;
        };

        window.openHalchashMenu = () => {
            document.getElementById('modalTitle').innerText = "স্মার্ট হালচাষ (" + window.currentLand.crop + ")";
            document.getElementById('modalContent').innerHTML = `
                <select id="plowSelect" class="smart-select">
                    ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1} টি চাষ</option>`).join('')}
                </select>
                <button class="action-btn" onclick="confirmWithPrism('হালচাষ')">অর্ডার নিশ্চিত করুন</button>`;
        };

        window.openFertilizerExpert = () => {
            const crop = window.currentLand.crop;
            const cropData = CROP_DB[crop] || CROP_DB['ধান'];
            document.getElementById('modalTitle').innerText = "সার নির্ধারণ (" + crop + ")";
            document.getElementById('modalContent').innerHTML = `
                <select id="cropVar" class="smart-select" onchange="calcFert()">
                    <option value="">জাত নির্বাচন করুন</option>
                    ${cropData.varieties.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select>
                <select id="cropStage" class="smart-select" onchange="calcFert()">
                    <option value="">ফসলের পর্যায়</option>
                    <option value="basal">জমি তৈরি (Basal)</option>
                    <option value="growth">বাড়ন্ত পর্যায় (Growth)</option>
                    <option value="fruit">ফুল/ফল আসা</option>
                </select>
                <div class="fert-grid">
                    <div class="fert-box"><label>ইউরিয়া (কেজি)</label><input type="number" id="uInp" class="fert-input" readonly></div>
                    <div class="fert-box"><label>DAP/TSP (কেজি)</label><input type="number" id="dInp" class="fert-input" readonly></div>
                    <div class="fert-box"><label>MOP (কেজি)</label><input type="number" id="mInp" class="fert-input" readonly></div>
                    <div class="fert-box"><label>জিপসাম (কেজি)</label><input type="number" id="gInp" class="fert-input" readonly></div>
                </div>
                <div id="reasonBox" class="reason-box"></div>
                <button class="action-btn" style="margin-top:20px;" onclick="confirmOrder()">অর্ডার নিশ্চিত করুন</button>`;
        };

        window.calcFert = () => {
            const varName = document.getElementById('cropVar').value;
            const stage = document.getElementById('cropStage').value;
            if(!varName || !stage) return;
            const { area, crop } = window.currentLand;
            const base = CROP_DB[crop].ratios;
            let u = base.urea, d = base.dap, m = base.mop;
            if(stage === 'basal') { u *= 0.2; d *= 1.3; }
            else if(stage === 'growth') { u *= 1.4; d *= 0.2; }
            else { u *= 0.4; m *= 1.5; }
            document.getElementById('uInp').value = (u * area).toFixed(1);
            document.getElementById('dInp').value = (d * area).toFixed(1);
            document.getElementById('mInp').value = (m * area).toFixed(1);
            document.getElementById('gInp').value = (base.gyp * area).toFixed(1);
            document.getElementById('reasonBox').innerHTML = `<b>সায়েন্টিফিক আপডেট:</b> ${varName} এর জন্য হিসাব অপ্টিমাইজড।`;
            document.getElementById('reasonBox').style.display = 'block';
        };

        window.closeModal = () => document.getElementById('serviceModal').style.display = 'none';
        window.confirmOrder = () => confirmWithPrism('সায়েন্টিফিক সার');

    </script>
</body>
</html>
