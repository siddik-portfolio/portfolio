<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Agri Map - Smart Farming</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        :root { --primary: #2E7D32; --accent: #39FF14; --glass: rgba(255, 255, 255, 0.9); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; background: #1a1a1a; }

        /* Modern UI Controls */
        .top-nav { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
        .glass-btn { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1); padding: 12px 20px; border-radius: 12px; font-weight: 600; color: #333; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.3s; text-decoration: none; }
        .glass-btn:hover { transform: translateY(-2px); background: white; }

        /* Improved Floating Card */
        .refined-float-card { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(5px);
            padding: 8px 12px; 
            border-radius: 10px; 
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 80px;
            pointer-events: none;
        }

        /* Modern Custom Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .custom-modal { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); text-align: left; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-input { width: 100%; padding: 12px; margin: 10px 0 20px 0; border: 2px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        .modal-input:focus { border-color: var(--primary); }
        .modal-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* Modern Result Bar */
        #result-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); width: 90%; max-width: 400px; background: var(--glass); backdrop-filter: blur(15px); padding: 20px; border-radius: 20px; z-index: 2000; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #result-box.active { transform: translateX(-50%) translateY(0); }

        /* Loading Overlay Improvements */
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.6s ease-in-out; }
        .loader-circle { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-circle"></div>
        <p style="margin-top:15px; font-weight: 600; color: #444;">প্রসেসিং হচ্ছে...</p>
    </div>

    <div id="map"></div>
    
    <div class="top-nav">
        <a href="Dashboard.html" class="glass-btn"><i class="fas fa-chevron-left"></i> ফিরে যান</a>
    </div>

    <div class="modal-overlay" id="input-modal">
        <div class="custom-modal">
            <h2 style="margin:0 0 10px 0; color:var(--primary);">জমির তথ্য</h2>
            <p style="color:#666; font-size:14px;">আপনার জমিটার একটি নাম এবং কি ফসল চাষ করছেন তা লিখুন।</p>
            
            <label style="font-weight:bold; font-size:14px;">জমির নাম</label>
            <input type="text" id="land-name" class="modal-input" placeholder="উদাঃ- উত্তর পাড়ার জমি">
            
            <label style="font-weight:bold; font-size:14px;">ফসলের নাম</label>
            <input type="text" id="crop-name" class="modal-input" placeholder="উদাঃ- আমন ধান">
            
            <button class="modal-btn" id="confirm-save">নিশ্চিত করুন</button>
        </div>
    </div>

    <div id="result-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div id="res-label" style="font-size:12px; color:#666; font-weight:bold; text-transform:uppercase;">পরিমাপকৃত এলাকা</div>
                <div id="res-value" style="font-size:24px; font-weight:bold; color:#222;">...</div>
            </div>
            <button class="glass-btn" id="save-trigger" style="background:var(--primary); color:white;">সেভ করুন</button>
        </div>
    </div>

    <div style="position:absolute; bottom:100px; right:20px; z-index:1000; display:flex; flex-direction:column; gap:10px;" id="drawing-controls">
        <button class="glass-btn" id="add-pt" style="width:60px; height:60px; border-radius:50%; justify-content:center; background:var(--primary); color:white;"><i class="fas fa-plus"></i></button>
        <button class="glass-btn" id="undo-pt" style="width:60px; height:60px; border-radius:50%; justify-content:center;"><i class="fas fa-undo"></i></button>
        <button class="glass-btn" id="done-pt" style="width:60px; height:60px; border-radius:50%; justify-content:center; background:#2196F3; color:white; display:none;"><i class="fas fa-check"></i></button>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let map, points = [], markers = [], polygonLayer, currentArea = 0, currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                currentUser = user; 
                initMap();
                const landId = new URLSearchParams(window.location.search).get('id');
                if(landId) loadLand(landId); else hideLoader();
            } else window.location.href = 'index.html';
        });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([23.81, 90.41], 15);
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);
        }

        async function loadLand(id) {
            const docSnap = await getDoc(doc(db, "lands", id));
            if (docSnap.exists()) {
                const land = docSnap.data();
                const path = land.points.map(p => [p.lat, p.lng]);
                
                polygonLayer = L.polygon(path, { color: '#39FF14', weight: 3, fillOpacity: 0.3 }).addTo(map);
                map.fitBounds(polygonLayer.getBounds(), { padding: [50, 50] });
                
                // Refined Float Card
                const center = polygonLayer.getBounds().getCenter();
                L.marker(center, {
                    icon: L.divIcon({
                        className: 'dummy',
                        html: `<div class="refined-float-card">
                                <div style="font-size:14px; font-weight:800;">${land.area} শতাংশ</div>
                                <div style="font-size:10px; opacity:0.8;">${land.name}</div>
                               </div>`,
                        iconSize: [100, 40], iconAnchor: [50, 20]
                    })
                }).addTo(map);
                
                document.getElementById('drawing-controls').style.display = 'none';
                hideLoader();
            }
        }

        function hideLoader() {
            const loader = document.getElementById('loading-overlay');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 600);
        }

        // Drawing Logic
        document.getElementById('add-pt').onclick = () => {
            const center = map.getCenter();
            points.push([center.lat, center.lng]);
            const m = L.circleMarker(center, { radius: 6, color: 'white', fillColor: '#39FF14', fillOpacity: 1 }).addTo(map);
            markers.push(m);
            updatePolygon();
            if(points.length >= 3) document.getElementById('done-pt').style.display = 'flex';
        };

        function updatePolygon() {
            if(polygonLayer) map.removeLayer(polygonLayer);
            polygonLayer = L.polygon(points, { color: '#39FF14', weight: 3, fillOpacity: 0.2 }).addTo(map);
        }

        document.getElementById('done-pt').onclick = () => {
            const polyGeo = turf.polygon([[...points, points[0]].map(p => [p[1], p[0]])]);
            currentArea = (turf.area(polyGeo) / 40.4686).toFixed(2);
            document.getElementById('res-value').innerText = currentArea + " শতাংশ";
            document.getElementById('result-box').classList.add('active');
        };

        // Modern Save Flow
        document.getElementById('save-trigger').onclick = () => {
            document.getElementById('input-modal').style.display = 'flex';
        };

        document.getElementById('confirm-save').onclick = async () => {
            const name = document.getElementById('land-name').value;
            const crop = document.getElementById('crop-name').value;
            
            if(!name || !crop) return alert("সবগুলো তথ্য পূরণ করুন");

            document.getElementById('confirm-save').innerText = "সেভ হচ্ছে...";
            try {
                await addDoc(collection(db, "lands"), {
                    name, cropName: crop, area: currentArea,
                    points: points.map(p => ({lat: p[0], lng: p[1]})),
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                window.location.href = 'Dashboard.html';
            } catch (e) { alert("Error!"); }
        };
    </script>
</body>
</html>
