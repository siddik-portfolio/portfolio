<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Map - Agri Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .top-btn { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; cursor: pointer; text-decoration: none; color: #333; display: flex; align-items: center; gap: 5px; }
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 1000; }
        .btn-action { background: white; border: none; padding: 15px 20px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .btn-add { background: #4CAF50; color: white; } 
        .btn-undo { background: white; color: #f44336; } 
        .btn-done { background: #2196F3; color: white; display: none; }
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 900; pointer-events: none; color: white; font-size: 30px; text-shadow: 0 0 5px black; }
        
        #result-box { position: absolute; bottom: 0; left: 0; width: 100%; background: white; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 2000; transform: translateY(100%); transition: 0.3s; }
        #result-box.active { transform: translateY(0); }
        .result-title { font-size: 18px; font-weight: bold; color: #2E7D32; margin-bottom: 5px; }
        .result-val { font-size: 24px; color: #333; font-weight: bold; margin-bottom: 15px; }
        .btn-save { width: 100%; padding: 15px; background: #2E7D32; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-close { width: 100%; padding: 12px; background: #f5f5f5; color: #555; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .gps-btn { position: absolute; bottom: 120px; right: 20px; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer; }

        /* Modern Input Modal */
        #input-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; align-items: center; justify-content: center; }
        .input-card { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
        .input-card h3 { margin-bottom: 15px; color: #333; }
        .input-card input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .input-btns { display: flex; gap: 10px; }
        .btn-confirm { flex: 1; background: #2E7D32; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #555; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Success Popup Style */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; position: relative; animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-icon { font-size: 60px; color: #4CAF50; margin-bottom: 15px; }
        .modal-card h2 { margin: 0 0 10px; color: #333; }
        .modal-card p { color: #666; margin-bottom: 25px; line-height: 1.6; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; }
        .modal-btn-go { background: #2E7D32; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .modal-close-x { position: absolute; top: 15px; right: 15px; font-size: 20px; color: #999; cursor: pointer; border: none; background: none; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="crosshair" id="crosshair-target"><i class="fas fa-plus-circle"></i></div>
    
    <a href="Dashboard.html" class="top-btn"><i class="fas fa-arrow-left"></i> ফিরে যান</a>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>

    <div class="controls" id="control-bar">
        <button class="btn-action btn-undo" id="undo-btn"><i class="fas fa-undo"></i></button>
        <button class="btn-action btn-add" id="add-btn">পয়েন্ট +</button>
        <button class="btn-action btn-done" id="done-btn">শেষ</button>
    </div>

    <div id="result-box">
        <h3 class="result-title" id="res-title">ফলাফল</h3>
        <div class="result-val" id="res-value">...</div>
        <p id="res-desc" style="color:#666; font-size:14px; margin-bottom:15px;">...</p>
        <button class="btn-save" id="save-btn">প্রোফাইলে সেভ করুন</button>
        <button class="btn-close" id="reset-btn">আবার মাপুন</button>
    </div>

    <div id="input-modal">
        <div class="input-card">
            <h3>জমির নাম দিন</h3>
            <input type="text" id="land-name-input" placeholder="উদা: উত্তর মাঠের জমি" value="আমার জমি">
            <div class="input-btns">
                <button class="btn-cancel" onclick="closeInputModal()">বাতিল</button>
                <button class="btn-confirm" id="confirm-save-btn">সেভ নিশ্চিত করুন</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="success-modal">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div class="modal-icon"><i class="fas fa-check-circle"></i></div>
            <h2>সফলভাবে সেভ হয়েছে!</h2>
            <p>আপনার জমিতি সফলভাবে প্রোফাইলে যুক্ত করা হয়েছে। এখনই ফসলের নাম সেট করতে চান?</p>
            <div class="modal-btns">
                <button class="modal-btn-go" onclick="goToProfile()">ফসলের নাম যোগ করুন</button>
                <button class="btn-close" style="margin:0; background:#eee;" onclick="closeModal()">পরে করব</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { collection, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        var map, points = [], markers = [], polygonLayer;
        var currentArea = 0;
        var currentUser = null;

        window.closeModal = () => { document.getElementById('success-modal').style.display = 'none'; };
        window.closeInputModal = () => { document.getElementById('input-modal').style.display = 'none'; };
        window.goToProfile = () => { window.location.href = 'Dashboard.html'; };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initMap();
                const params = new URLSearchParams(window.location.search);
                const mode = params.get('mode') || 'measure';
                const landId = params.get('landId');
                if (mode === 'view' && landId) { loadLandFromFirebase(landId); }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([23.8103, 90.4125], 15);
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20, attribution: 'Google'
            }).addTo(map);
            L.Control.geocoder().addTo(map);
        }

        async function loadLandFromFirebase(id) {
            try {
                const docRef = doc(db, "lands", id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const land = docSnap.data();
                    document.getElementById('control-bar').style.display = 'none';
                    document.getElementById('crosshair-target').style.display = 'none';
                    points = land.points.map(p => [p.lat, p.lng]);
                    polygonLayer = L.polygon(points, { color: '#39FF14', weight: 4 }).addTo(map);
                    map.fitBounds(polygonLayer.getBounds(), { padding: [50, 50] });
                    document.getElementById('result-box').classList.add('active');
                    document.getElementById('res-title').innerText = land.name;
                    document.getElementById('res-value').innerText = land.area + " শতাংশ";
                    document.getElementById('res-desc').innerText = "তারিখ: " + (land.date || "N/A");
                    document.getElementById('save-btn').style.display = 'none';
                }
            } catch (err) { console.error("Data load failed:", err); }
        }

        document.getElementById('add-btn').onclick = () => {
            var center = map.getCenter();
            points.push([center.lat, center.lng]);
            var marker = L.circleMarker(center, { color: 'white', fillColor: '#39FF14', fillOpacity: 1, radius: 5 }).addTo(map);
            markers.push(marker);
            updatePolygon();
            if(points.length >= 3) document.getElementById('done-btn').style.display = 'flex';
        };

        document.getElementById('undo-btn').onclick = () => {
            if(points.length > 0) {
                points.pop();
                var m = markers.pop();
                if(m) map.removeLayer(m);
                updatePolygon();
                if(points.length < 3) document.getElementById('done-btn').style.display = 'none';
            }
        };

        function updatePolygon() {
            if(polygonLayer) map.removeLayer(polygonLayer);
            if(points.length > 0) {
                polygonLayer = L.polygon(points, { color: '#39FF14', weight: 3, fillOpacity: 0.3 }).addTo(map);
            }
        }

        document.getElementById('done-btn').onclick = () => {
            if (points.length < 3) return;
            document.getElementById('control-bar').style.display = 'none';
            document.getElementById('crosshair-target').style.display = 'none';
            var tPoints = [...points, points[0]];
            var polygon = turf.polygon([tPoints.map(p => [p[1], p[0]])]);
            currentArea = (turf.area(polygon) / 40.4686).toFixed(2);
            document.getElementById('result-box').classList.add('active');
            document.getElementById('res-value').innerText = currentArea + " শতাংশ";
            document.getElementById('res-title').innerText = "পরিমাপ সম্পন্ন";
            document.getElementById('res-desc').innerText = "চিহ্নিত এলাকার মোট আয়তন উপরে দেখা যাচ্ছে।";
        };

        // সেভ বাটন ক্লিক করলে ইনপুট মোডাল দেখাবে
        document.getElementById('save-btn').onclick = () => {
            if (!currentUser) { alert("লগইন সেশন পাওয়া যায়নি!"); return; }
            document.getElementById('input-modal').style.display = 'flex';
        };

        // মোডাল থেকে নিশ্চিত করলে ফাইনাল সেভ হবে
        document.getElementById('confirm-save-btn').onclick = async () => {
            const landName = document.getElementById('land-name-input').value.trim();
            if (!landName) { alert("জমির নাম দিন!"); return; }

            const btn = document.getElementById('confirm-save-btn');
            const saveBtnUi = document.getElementById('save-btn');
            
            try {
                btn.innerText = "সেভ হচ্ছে...";
                btn.disabled = true;

                // Firebase-এর জন্য ক্লিন ডেটা অবজেক্ট তৈরি (এরর এড়াতে)
                const firebasePoints = points.map(p => ({
                    lat: parseFloat(p[0]),
                    lng: parseFloat(p[1])
                }));

                await addDoc(collection(db, "lands"), {
                    userId: currentUser.uid,
                    name: landName,
                    area: parseFloat(currentArea),
                    points: firebasePoints,
                    cropType: "নির্বাচন করুন",
                    date: new Date().toLocaleDateString('bn-BD'),
                    timestamp: serverTimestamp()
                });

                closeInputModal();
                saveBtnUi.innerText = "সফলভাবে সেভ হয়েছে ✅";
                saveBtnUi.disabled = true;
                document.getElementById('success-modal').style.display = 'flex';
                
            } catch (error) {
                console.error("Save Error:", error);
                alert("সেভ করতে সমস্যা হয়েছে। অনুগ্রহ করে ইন্টারনেট চেক করুন।");
                btn.innerText = "আবার চেষ্টা করুন";
                btn.disabled = false;
            }
        };

        document.getElementById('reset-btn').onclick = () => location.reload();
        window.locateUser = () => { map.locate({setView: true, maxZoom: 18}); };
        map.on('locationerror', () => alert("লোকেশন পাওয়া যায়নি। জিপিএস অন করুন।"));

    </script>
</body>
</html>
