<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Map - Agri Pro</title>
    
    <link rel="preconnect" href="https://mt1.google.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #f0f0f0; }
        .top-btn { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; cursor: pointer; text-decoration: none; color: #333; display: flex; align-items: center; gap: 5px; }
        
        /* লোডিং ওভারলে */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2E7D32; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; gap: 15px; z-index: 1000; }
        .btn-action { background: white; border: none; padding: 15px 20px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .btn-add { background: #4CAF50; color: white; } 
        .btn-undo { background: white; color: #f44336; } 
        .btn-done { background: #2196F3; color: white; display: none; }
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 900; pointer-events: none; color: white; font-size: 30px; text-shadow: 0 0 5px black; display: none; }
        
        #result-box { position: absolute; bottom: 0; left: 0; width: 100%; background: white; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 2000; transform: translateY(100%); transition: 0.3s; }
        #result-box.active { transform: translateY(0); }
        .result-title { font-size: 18px; font-weight: bold; color: #2E7D32; margin-bottom: 5px; }
        .result-val { font-size: 24px; color: #333; font-weight: bold; margin-bottom: 15px; }
        .btn-save { width: 100%; padding: 15px; background: #2E7D32; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-close { width: 100%; padding: 12px; background: #f5f5f5; color: #555; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .gps-btn { position: absolute; bottom: 120px; right: 20px; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer; }

        /* 3D Floating Card Style */
        .float-card { background: white; padding: 10px 15px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); border-bottom: 4px solid #2E7D32; text-align: center; min-width: 100px; transform: perspective(200px) rotateX(10deg); }

        #input-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; align-items: center; justify-content: center; }
        .input-card { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; position: relative; animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#2E7D32;">লোড হচ্ছে...</p>
    </div>

    <div id="map"></div>
    <div class="crosshair" id="crosshair-target"><i class="fas fa-plus-circle"></i></div>
    
    <a href="Dashboard.html" class="top-btn"><i class="fas fa-arrow-left"></i> ফিরে যান</a>
    <div class="gps-btn" id="gps-trigger"><i class="fas fa-crosshairs"></i></div>

    <div class="controls" id="control-bar">
        <button class="btn-action btn-undo" id="undo-btn"><i class="fas fa-undo"></i></button>
        <button class="btn-action btn-add" id="add-btn">পয়েন্ট +</button>
        <button class="btn-action btn-done" id="done-btn">শেষ</button>
    </div>

    <div id="result-box">
        <h3 class="result-title" id="res-title">ফলাফল</h3>
        <div class="result-val" id="res-value">...</div>
        <p id="res-desc" style="color:#666; font-size:14px; margin-bottom:15px;">...</p>
        <button class="btn-save" id="save-btn">প্রোফাইলে সেভ করুন</button>
        <button class="btn-close" id="reset-btn">বন্ধ করুন</button>
    </div>

    <div id="input-modal">...</div> 
    <div class="modal-overlay" id="success-modal">...</div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let map, points = [], markers = [], polygonLayer;
        let currentArea = 0;
        let currentUser = null;

        const urlParams = new URLSearchParams(window.location.search);
        const landId = urlParams.get('id');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                initMap();
                if (landId) {
                    loadSpecificLand(landId);
                } else {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('control-bar').style.display = 'flex';
                    document.getElementById('crosshair-target').style.display = 'block';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initMap() {
            if (map) return;
            map = L.map('map', { 
                zoomControl: false,
                preferCanvas: true 
            }).setView([23.8103, 90.4125], 15);

            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20, 
                updateWhenIdle: true
            }).addTo(map);

            L.Control.geocoder({ position: 'topright' }).addTo(map);
            document.getElementById('gps-trigger').onclick = () => map.locate({setView: true, maxZoom: 18});
        }

        async function loadSpecificLand(id) {
            try {
                const docSnap = await getDoc(doc(db, "lands", id));
                if (docSnap.exists()) {
                    const land = docSnap.data();
                    const landPoints = land.points.map(p => [p.lat, p.lng]);

                    // ১. Instant Zoom: এনিমেশন ছাড়া জমিটার বাউন্ডারি সেট করা
                    const tempPoly = L.polygon(landPoints);
                    map.fitBounds(tempPoly.getBounds(), { animate: false, padding: [50, 50] });

                    // ২. পলিগন ড্রয়িং
                    if(polygonLayer) map.removeLayer(polygonLayer);
                    polygonLayer = L.polygon(landPoints, { color: '#39FF14', weight: 4, fillOpacity: 0.4 }).addTo(map);
                    
                    landPoints.forEach(p => {
                        L.circleMarker(p, { color: 'white', fillColor: '#39FF14', fillOpacity: 1, radius: 5 }).addTo(map);
                    });

                    // ৩. 3D Floating Card যোগ করা
                    const center = tempPoly.getBounds().getCenter();
                    const floatIcon = L.divIcon({
                        className: 'dummy',
                        html: `<div class="float-card">
                                    <div style="font-size:16px; font-weight:bold; color:#333;">${land.area} শতাংশ</div>
                                    <div style="font-size:11px; color:#2E7D32; font-weight:bold;">${land.name}</div>
                               </div>`,
                        iconSize: [120, 60],
                        iconAnchor: [60, 30]
                    });
                    L.marker(center, { icon: floatIcon }).addTo(map);

                    // ৪. লোডার সরানো
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);

                    // রেজাল্ট বক্সের বাটন কনফিগারেশন
                    document.getElementById('result-box').classList.add('active');
                    document.getElementById('res-title').style.display = 'none';
                    document.getElementById('res-value').style.display = 'none';
                    document.getElementById('res-desc').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'none';
                    document.getElementById('reset-btn').innerText = "ড্যাশবোর্ডে ফিরুন";
                    document.getElementById('reset-btn').onclick = () => window.location.href = 'Dashboard.html';
                }
            } catch (error) { 
                console.error("Error:", error); 
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // মাপার লজিক (Add Point, Undo, Done)
        document.getElementById('add-btn').onclick = () => {
            const center = map.getCenter();
            points.push([center.lat, center.lng]);
            const marker = L.circleMarker(center, { color: 'white', fillColor: '#39FF14', fillOpacity: 1, radius: 6 }).addTo(map);
            markers.push(marker);
            if(polygonLayer) map.removeLayer(polygonLayer);
            polygonLayer = L.polygon(points, { color: '#39FF14', weight: 3, fillOpacity: 0.3 }).addTo(map);
            if(points.length >= 3) document.getElementById('done-btn').style.display = 'flex';
        };

        document.getElementById('undo-btn').onclick = () => {
            if(points.length > 0) {
                points.pop();
                const m = markers.pop();
                if(m) map.removeLayer(m);
                if(polygonLayer) map.removeLayer(polygonLayer);
                polygonLayer = L.polygon(points, { color: '#39FF14', weight: 3, fillOpacity: 0.3 }).addTo(map);
                if(points.length < 3) document.getElementById('done-btn').style.display = 'none';
            }
        };

        document.getElementById('done-btn').onclick = () => {
            const tPoints = [...points, points[0]];
            const polyGeo = turf.polygon([tPoints.map(p => [p[1], p[0]])]);
            currentArea = (turf.area(polyGeo) / 40.4686).toFixed(2);
            
            // মাপার পর ভাসমান কার্ড দেখানো
            const center = polygonLayer.getBounds().getCenter();
            L.marker(center, {
                icon: L.divIcon({
                    className: 'dummy',
                    html: `<div class="float-card" style="border-bottom-color:#2196F3;">
                                <div style="font-size:16px; font-weight:bold;">${currentArea} শতাংশ</div>
                           </div>`,
                    iconSize: [100, 40], iconAnchor: [50, 20]
                })
            }).addTo(map);

            document.getElementById('res-value').innerText = currentArea + " শতাংশ";
            document.getElementById('result-box').classList.add('active');
            document.getElementById('control-bar').style.display = 'none';
            document.getElementById('crosshair-target').style.display = 'none';
        };

        document.getElementById('reset-btn').onclick = () => location.reload();
    </script>
</body>
</html>
